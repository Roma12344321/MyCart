create table Person(
    id int generated by default as identity primary key,
    username varchar(100) not null unique,
    year int check ( year>1900 ),
    mail varchar(120),
    password varchar(100) not null,
    role varchar not null
    created_at timestamp default not null
);

create table Category(
    id int generated by default as identity primary key,
    name varchar(100) not null unique
);

create table Good(
    id int generated by default as identity primary key,
    name varchar(100) not null unique,
    price int not null,
    description varchar,
    cat_id int references category(id) on delete set null
    image_path VARCHAR(255)
);

CREATE TABLE Cart
(
    id        INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    person_id INT REFERENCES person (id) ON DELETE CASCADE,
    good_id   INT REFERENCES good (id) ON DELETE CASCADE,
    amount    INT CHECK (amount > -1) NOT NULL,
    UNIQUE (person_id, good_id)
);
CREATE INDEX idx_cart_person_id ON Cart(person_id);
CREATE INDEX idx_cart_good_id ON Cart(good_id);

create table orders
(
    id        int generated by default as identity,
    person_id int references person (id) on delete cascade,
    good_id   int references good (id) on delete cascade,
    amount    int check ( amount > -1 ) not null,
    address   varchar,
    status    varchar,
    date      timestamp,
    primary key (person_id, good_id)
);

create table Tag(
    id int generated by default as identity primary key,
    name varchar(100) not null unique
);

create table tag_good(
    good_id int references good(id),
    tag_id int references tag(id),
    primary key(good_id,tag_id)
);

create table balance(
    id int generated by default as identity primary key,
    sum int check ( sum>=0 ),
    person_id int references person(id) on delete cascade unique not null
);

create table Comment
(
    id int generated by default as identity primary key,
    person_id int references person(id) on delete set null,
    good_id int references good(id) on delete cascade,
    text varchar not null,
    star int check ( star>0 ) check ( star<=10 ) not null,
    date timestamp
);
CREATE INDEX idx_comment_good_id ON comment(good_id);

CREATE TABLE likes
(
    id        INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    person_id INT REFERENCES person (id) ON DELETE set null ,
    good_id   INT REFERENCES good (id) ON DELETE CASCADE,
    UNIQUE (person_id, good_id)
);

CREATE INDEX idx_likes_good_id ON likes(good_id);
